\section{Sistema TRUE}

O sistema TRUE (\textit{Tracking and Recognizing Users in the Environment})
realiza a identificação, localização e rastreamento de usuário em um ambiente
inteligente. Para isso são utilizados os dados de vídeo e profundidade providos pelo sensor
\textit{Kinect}~\cite{kinect_microsoft}. Por fim estas informações são disponibilizadas
para as aplicações através do middleware \textit{uOS}~\cite{fabriciobuzzeto, alegomes}.
O projeto é composto por 4 módulos conforme representado na
Figura~\ref{fig:relacao-modulos}.

\begin{figure}[htb]
	\begin{center}
		\includegraphics[scale=0.5]{img/modulo-integracao.png}
	\end{center}
	\caption{Interação entre o módulos do Sistema TRUE.}
	\label{fig:relacao-modulos}
\end{figure}

\subsection{Módulo de Rastreamento}

O Módulo de Rastreamento é responsável por rastrear os usuários no ambiente,
determinar a sua localização física em relação ao sensor \textit{Kinect} e
gerenciar suas identidades. Para realizar o rastreamento e localização dos
usuários é utilizada a biblioteca \textit{OpenNI} (\textit{Open Natural
Interaction}). Trata-se de um \textit{framework} que define \textit{APIs} para o
desenvolvimento de aplicações de interação natural.

Para a detecção e rastreamento do usuário é utilizada a técnica de subtração de
fundo com a representação de silhuetas. A localização, por sua vez, é realizada
utilizando-se imagens de profundidade que fornecem as coordenadas do centro de
massa do usuário. Tais coordenadas são compostas por três dimensões onde o
sensor é considerado como a origem do plano.

O processo de rastreamento começa inicializando o dispositivo de entrada, no
caso o sensor \textit{Kinect}, registrando as ações a serem tomadas quando
eventos em relação aos usuários ocorram, como, por exemplo, evento de novo
usuário detectado ou usuário perdido. Obtém-se então uma imagem de fundo da cena
que será utilizada no processo de subtração de fundo. Para cada imagem obtida da
cena, o processo de subtração de fundo é realizado atualizando os parâmetros de
cada usuário, como sua posição na imagem e sua posição em relação ao sensor.

O Módulo de Rastreamento detém as informações sobre todos os usuários rastreados
no ambiente e é responsável por requisitar identificação ao Módulo de
Reconhecimento. Isto acontece sempre que um novo usuário for detectado ou quando
for necessário reconhecer novamente um usuário já rastreado. Quando um novo
usuário for detectado, o Módulo de Rastreamento obtém 20 imagens de cor
sucessivas deste usuário. De cada imagem é extraída a região correspondente a
face e enviada ao Módulo de Reconhecimento requisitando identificação ao mesmo.
O Módulo de Reconhecimento, por sua vez, realiza o reconhecimento facial e
retorna ao Módulo de Rastreamento o nome do usuário e a confiança obtida. A cada
500ms, o Módulo de Reconhecimento verifica se chegou algum resultado de
identificação. Caso tenha chegado, o Módulo de Rastreamento computa o resultado
e decide qual identidade será atribuída ao respectivo usuário.

Ao invés de realizar o reconhecimento somente quando novos usuários são
detectados, com o objetivo de melhorar a confiança do reconhecimento, o Sistema
TRUE realiza continuamente a identificação dos usuários já reconhecidos. Essas
tentativas de reconhecer novamente os usuários ocorrerão a cada 5 segundos
seguindo as mesmas etapas de quando um novo usuário for detectado. A única
etapa que se difere é a primeira, ou seja, ao invés de obter várias imagens de
um mesmo usuário, é obtida uma imagem de cada usuário rastreado e a mesma é
enviada ao Módulo de Reconhecimento.

Ao obter um resultado de reconhecimento para determinado usuário, o Módulo de
Rastreamento deve computar qual identidade será atribuída ao mesmo. Para isso,
este módulo mantém para cada usuário o número total de vezes que este já foi
reconhecido e os diferentes nomes obtidos pelo Módulo de Reconhecimento bem
como a confiança média para cada nome e o número de vezes que cada nome foi
atribuído àquele usuário. Com todos esses dados, a identidade do usuário é
definida por meio da Fórmula~\ref{eq:media_ponderada}.

\begin{equation}
	\label{eq:media_ponderada}
	M_p = \frac{N_1 * C_1 + N_2 * C_2 + ... + N_n * C_n}{N_1 + N_2 + ... + N_n}
\end{equation}

\subsection{Módulo de Reconhecimento}
O Módulo de Reconhecimento é responsável pela identificação dos usuários no
ambiente. Para isto é utilizada a imagem do usuário (obtida pelo módulo de
rastreamento) de onde se obtém a face do mesmo. Desta forma o reconhecimento
pode ser realizado sem atuação explícita ou intrusão nas atividades do usuário.
Seu funcionamento consiste nos seguintes passos:

\begin{enumerate}
	\item Obtenção da imagem de entrada composta somente pelo usuário cujo
	 reconhecimento foi requisitado. 
	\item Pré-processamento da imagem, ou seja, conversão da imagem em escala de
	cinza.
	\item  Detecção facial na imagem. Caso nenhuma face seja encontrada, retorna
	 ``vazio''. Observa-se que no máximo uma face pode ser encontrada nesta
	 imagem.
	\item  Processamento da imagem, ou seja, uma nova imagem é criada recortando a
	região da face encontrada. A imagem é, então, redimensionada e equalizada criando assim
	um padrão de tamanho, brilho e contraste aumentando a acurácia do reconhecimento.
	\item  Reconhecimento facial com a técnica Eigenfaces. 
	\item  Retorno do nome do usuário com a face ``mais parecida'' e a confiança do
	 reconhecimento.
\end{enumerate}

A detecção facial foi desenvolvida utilizando o método
\textit{Viola-Jones}~\cite{edsonma, violajones}. O \textit{Viola-Jones} é
implementado pela biblioteca \textit{OpenCV}~\cite{opencv_library} (\textit{Open
Source Computer Vision}). Basicamente, o processo de detecção facial procura por
uma face em uma imagem pré-processada. Para realizar detecção facial utilizando
o método \textit{Viola-Jones} é necessário a utilização de um classificador em
cascata. O Sistema TRUE utiliza um classificador treinado para detectar faces
frontais em imagens.

O reconhecimento facial foi desenvolvido utilizando a técnica
\textit{Eigenfaces}~\cite{hewitt, artigo-eigenface}. Consiste em uma técnica
bastante satisfatória quando utilizada sobre uma base de faces relativamente
grande, permitindo ao sistema inferir, das imagens das faces suas principais
características e, partindo delas, realizar o reconhecimento facial utilizando
um número reduzido de cálculos, permitindo, assim, um reconhecimento em tempo
real. A base de dados utilizada no Sistema TRUE é formada por imagens no formato
PGM (\textit{Portable Gray Map}) com tamanho de 92x112 pixels e em escala de
cinza.

O reconhecimento facial inicia-se projetando a imagem no subespaço através do
método PCA~\cite{belhumeur} que reduz sua dimensionalidade. Então, calcula-se a
distância da imagem projetada a cada um dos \textit{eigenfaces} obtidos na etapa
de treinamento obtendo uma lista de distâncias. Esta lista de distâncias é
comparada com a lista de distâncias de cada usuário, também obtidas na etapa de
treinamento, obtendo o usuário cuja lista de distâncias é a mais similar. Para o
cálculo da distância é utilizado tanto a distância Euclidiana como o Mahalanobis
~\cite{perlibakas}. Conforme exposto na Sessão \ref{sec:testes} foi observado
que a utilização de ambas apresentou resultados mais satisfatórios que ambas
isoladamente.

\subsection{Módulo de Registro}

O Módulo de Registro é responsável por cadastrar novos usuários no sistema e
treiná-lo para também reconhecer esse novo usuário. Este consiste das seguintes
etapas:
\begin{enumerate}
	\item Obtenção das imagens do novo usuário;
	\item Processamento das imagens, isto é, as imagens são convertidas em escala
	 de cinza, novas imagens são criadas recortando a região da face encontrada.
	 Em seguida, as imagens são redimensionadas e equalizadas criando assim
	 padrões de tamanho, brilho e contraste;
	\item Armazenamento das imagens;
	\item Treinamento do sistema para reconhecer esse usuário.
\end{enumerate}

A última etapa do módulo de registro consiste no treinamento do sistema. O
treinamento inicia-se liberando os atuais dados de treinamento. Então, um vetor
de imagens é obtido lendo todas as imagens contidas no banco de faces. Através
deste vetor, obtém-se a \textit{eigenface} média, os \textit{eigenfaces} e os
\textit{eigenvalues}. Para cada usuário cadastrado no Sistema TRUE, suas imagens
são projetadas no subespaço através do método PCA  que reduz suas
dimensionalidades, e são calculadas suas distâncias em relação aos eigenfaces
obtendo um vetor de distâncias. Os \textit{eigenfaces}, os \textit{eigenvalues},
a \textit{eigenface} média e os vetores de distâncias são armazenados e podem
ser utilizados pelo Módulo de Reconhecimento.

Após o treinamento, o Sistema TRUE é reiniciado para que o reconhecimento seja
feito utilizando as novas imagens e informações obtidas com o treinamento.

\subsection{Modulo de Integração}

O Módulo de Integração é responsável por disponibilizar ao ambiente os dados dos
usuários. Para isto o Sistema TRUE disponibiliza um \textit{Driver} de Usuário
(\textit{UserDriver}) para o middleware \textit{uOS}. Tal \textit{driver}
fornece os seguintes serviços de consulta e eventos: 

\begin{itemize}
	\item Serviços:
	\begin{itemize}
		\item Consultas as informações dos usuários no ambiente: através dessas
			consultas, as aplicações tem acesso aos nomes, e-mails, posições correntes e
			confiança do reconhecimento de todos os usuários presentes no ambiente; 
		\item Cadastro: as aplicações podem cadastrar novos usuários fornecendo ao
			\textit{UserDriver} o nome, o e-mail e as imagens do novo usuário;
		\item Treino do sistema: após cadastrar novos usuários as aplicações podem
			retreinar o sistema para poder reconhecer o novo usuário cadastrado;
		\item Remoção: as aplicações podem remover usuários cadastrados fornecendo o
		e-mail do usuário.
	\end{itemize}

	\item Eventos:
	\begin{itemize}	 
		\item Novo Usuário: evento gerado assim que um novo usuário foi detectado pelo
		 Sistema TRUE. 
		\item Usuário Perdido: evento gerado assim que um usuário deixou de ser
		 rastreado pelo Sistema TRUE. 
		\item Atualização dos dados do usuário: evento gerado a cada cinco segundos
		 atualizando os dados de todos os usuários rastreados.
	\end{itemize}
\end{itemize}